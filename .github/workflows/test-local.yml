# This action tests PyMAPDL with MAPDL running locally.
# It does support running with minimal requirements and with console interface.

name: "Local testing"

on:
  workflow_call:
    inputs:
      mapdl-version:
        description: |
          MAPDL version to test.
        required: true
        type: string

      latest-version:
        description: |
          Latest version of MAPDL.
        required: true
        type: string

      pytest-arguments:
        description: |
          Arguments to pass to pytest, additionally to the ones in the environment variable PYTEST_ARGUMENTS.
        required: false
        type: string
        default: ""

      testing-minimal: 
        description: |
          If true, the minimal requirements will be installed.
        required: false
        type: boolean
        default: false

      test_dpf:
        description: |
          If true, the DPF tests will be run.
        required: false
        type: boolean
        default: true

      on-console:
        description: |
          If true, the tests will be run on console.
        required: false
        type: boolean
        default: false

      upload-logs:
        description: |
          If true, logs will be uploaded encrypted. Set to false to disable log upload (for security).
        required: false
        type: boolean
        default: false

      file-name:
        description: |
          Name of the file to save the logs.
        required: true
        type: string

      tags:
        description: |
          Tags to add to the coverage report.
        required: false
        type: string

      codecov-report:
        description: |
          Whether to upload the coverage report to Codecov or not. If `true`, then the
          appropriate token is needed.
        required: false
        default: true
        type: boolean

      package-registry:
        description: |
          Package registry for the container.
        required: false
        type: string
        default: ghcr.io/ansys/mapdl

      runner:
        description: |
          Runner to use.
        required: false
        type: string
        default: ubuntu-22.04

      python-version:
        description: |
          Python version to use.
        required: false
        type: string
        default: "3.12"

    secrets:
      license-server:
        description: |
          License server for ANSYS MAPDL
        required: true

      codecov-token:
        description: |
          Token for Codecov.
        required: true

      log-encryption-key:
        description: |
          Encryption key for sensitive log files.
        required: false

      token:
        description: |
          Token for GitHub. Used also for login into ghcr.io.
        required: true

      username:
        description: |
          GitHub username for login into ghcr.io.
        required: true

# zizmor: ignore[concurrency-limits]
# Concurrency is controlled by the parent workflow (ci.yml)

permissions: {}

jobs:
  test-local:
    name: Test MAPDL locally
    runs-on: ${{ inputs.runner }}
    permissions:
      contents: read  # Needed to read repository contents for tests
      packages: read  # Needed to pull Docker images from GitHub packages
    env:
      ON_CI: True
      ON_LOCAL: true
      ON_UBUNTU: true
      HAS_DPF: ${{ inputs.test_dpf }}
      PYMAPDL_DEBUG_TESTING: True
      TESTING_MINIMAL: ${{ inputs.testing-minimal }}
      P_SCHEMA: "/ansys_inc/v241/ansys/ac4/schema"
      PYTEST_TIMEOUT: 120 # seconds. Limit the duration for each unit test
      PYTEST_ARGUMENTS: '-vvv -ra --color=yes --durations=30 --random-order --random-order-bucket=class --maxfail=2 --reruns 2 --reruns-delay 2 --cov=ansys.mapdl.core --cov-report=html --timeout=180 --profile-svg --profile --report-log-exclude-logs-on-passed-tests --strict-markers'
      OMPI_ALLOW_RUN_AS_ROOT: 1
      OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
      DATAPROCESSING_DEBUG: /home/mapdl/dpf_logs

    container:
      image: "${{ inputs.package-registry }}:${{ inputs.mapdl-version }}" # zizmor: ignore[unpinned-images]
      options: -u=0:0 --oom-kill-disable --memory=6656MB --memory-swap=16896MB --shm-size=1gb --entrypoint /bin/bash
      credentials:
        username: ${{ secrets.username }}
        password: ${{ secrets.token }}

    steps:
      - name: "Freeing some space and show space consumption (pre-test)"
        shell: bash
        run: |
          echo "Deleting CodeQL..."
          rm -rf /__t/CodeQL || echo "CodeQL not found"

          echo "Disk space:"
          df -h

      - name: "Install Git and checkout project"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          repository: ansys/pymapdl
          persist-credentials: false

      - name: "Get if running student version"
        id: student_check
        shell: bash
        env:
          MAPDL_VERSION: ${{ inputs.mapdl-version }}
        run: |
          if [[ "${MAPDL_VERSION}" == *"student"* ]]; 
            then export ON_STUDENT=true; export TAG_STUDENT="student";
            else export ON_STUDENT=false; export TAG_STUDENT="non-student";
          fi

          if [[ "${MAPDL_VERSION}" == *"cicd"* ]]; then
            echo "CICD MAPDL version detected, testing DPF backend for results module.";
            echo "TEST_DPF_BACKEND=true" >> $GITHUB_ENV;
            echo "PYMAPDL_ADDITIONAL_SWITCHES=-mpi openmpi" >> $GITHUB_ENV;
          fi

          echo "ON_STUDENT: $ON_STUDENT"
          echo "TAG_STUDENT: $TAG_STUDENT"
          echo "ON_STUDENT=$(echo $ON_STUDENT)" >> $GITHUB_OUTPUT
          echo "TAG_STUDENT=$(echo $TAG_STUDENT)" >> $GITHUB_OUTPUT

      - name: "Install gcc"
        shell: bash
        if: ${{ contains(inputs.mapdl-version, 'cicd') }}
        run: |
          apt-get update && apt-get -y install gcc mono-mcs g++


      - name: "Installing minimal OS packages"
        shell: bash
        if: inputs.testing-minimal == true
        run: |
          apt-get update && apt install -y libgomp1 graphviz curl git && apt-get clean

      - name: "Installing OS packages"
        shell: bash
        if: inputs.testing-minimal == false
        run: |
          apt-get update && apt install -y libgl1 libglx-mesa0 xvfb libgomp1 graphviz curl git && apt-get clean

      - name: "Setup Python"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 #v6.1.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: "Checking Python"
        shell: bash
        run: |
          python --version
          python -m pip install --upgrade pip

      - name: "Install ansys-mapdl-core"
        if: inputs.testing-minimal == false
        shell: bash
        run: |
          python -m pip install build
          python -m build
          python -m pip install dist/*.whl
          xvfb-run python -c "from ansys.mapdl import core as pymapdl; print(pymapdl.Report())"

      - name: "Install ansys-mapdl-core with minimal requirements"
        shell: bash
        if: inputs.testing-minimal == true
        run: |
          python -m pip install . --no-deps
          python -m pip install -r minimum_requirements.txt
          python -c "from ansys.mapdl import core as pymapdl; print('Import successfull')"

      - name: "Unit testing requirements installation"
        if: inputs.testing-minimal == false
        shell: bash
        run: |
          python -m pip install .[tests]

      - name: "Unit testing requirements installation"
        if: inputs.testing-minimal == true
        shell: bash
        run: |
          python -m pip install -r .ci/requirements_testing_minimal.txt

      - name: "Unit testing"
        env:
          ON_STUDENT: ${{ steps.student_check.outputs.ON_STUDENT }}
          ON_MINIMAL: ${{ inputs.testing-minimal }}
          ON_CONSOLE: ${{ inputs.on-console }}
          ANSYSLMD_LICENSE_FILE: "1055@${{ secrets.license-server }}"
          file_name: ${{ inputs.file-name }}
          PYTEST_ARGUMENTS: "${{ env.PYTEST_ARGUMENTS }}"
          MAPDL_VERSION: ${{ inputs.mapdl-version }}
          PYTEST_INPUT_ARGUMENTS: "${{ inputs.pytest-arguments }}"
          LATEST_VERSION: "${{ inputs.latest-version }}"
        shell: bash
        run: |
          echo "ON_UBUNTU: $ON_UBUNTU"
          echo "ON_STUDENT: $ON_STUDENT"

          # Because there is no 'ansys-tools-common' we need to input the
          # executable path with the env var: PYMAPDL_MAPDL_EXEC.

          if [[ "${MAPDL_VERSION}" == *"latest-ubuntu"* ]] ; then
            version=${LATEST_VERSION}
          else
            version=$(echo "${MAPDL_VERSION}" | head -c 5 | tail -c 4 | tr -d '.')
          fi;

          echo "Version: $version"

          # If minimal is true, we need to set the executable path.
          if [[ "${ON_MINIMAL}" == "true" ]]; then
            echo "PYMAPDL_MAPDL_EXEC: $PYMAPDL_MAPDL_EXEC"
            export PYMAPDL_MAPDL_EXEC=/ansys_inc/v"$version"/ansys/bin/ansys"$version"
            export cmd="pytest"
          else
            export cmd="xvfb-run pytest"
          fi;

          unset PYMAPDL_START_INSTANCE
          unset PYMAPDL_PORT

          $cmd ${PYTEST_INPUT_ARGUMENTS} \
            ${PYTEST_ARGUMENTS} \
            --report-log=$file_name.jsonl \
            --cov-report=xml:$file_name.xml

      - name: "Upload pytest reports to GitHub"
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: "reports-${{ inputs.file-name }}"
          path: ./${{ inputs.file-name }}.jsonl

      - name: "Collect logs on failure"
        if: always()
        env:
          LOG_NAMES: logs-${{ inputs.file-name }}
        shell: bash
        run: |
          .ci/collect_mapdl_logs_locals.sh

      - name: "Encrypt and upload logs to GitHub"
        if: always() && inputs.upload-logs == true
        env:
          ENCRYPTION_KEY: ${{ secrets.log-encryption-key }}
          FILE_NAME: ${{ inputs.file-name }}
        shell: bash
        run: |
          # Check if logs exist
          if [ -f "./logs-${FILE_NAME}.tgz" ]; then
            echo "Encrypting logs..."

            # Encrypt using OpenSSL (already available in container)
            openssl enc -aes-256-cbc -salt -pbkdf2 \
              -in ./logs-${FILE_NAME}.tgz \
              -out ./logs-${FILE_NAME}.tgz.enc \
              -pass env:ENCRYPTION_KEY

            echo "Logs encrypted successfully"
            echo "To decrypt locally, use:"
            echo "openssl enc -aes-256-cbc -d -pbkdf2 -in logs-${FILE_NAME}.tgz.enc -out logs-${FILE_NAME}.tgz -pass pass:YOUR_KEY"
          else
            echo "No log file found to encrypt"
          fi

      - name: "Upload encrypted logs to GitHub"
        if: always() && inputs.upload-logs == true
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: logs-${{ inputs.file-name }}-encrypted
          path: ./logs-${{ inputs.file-name }}.tgz.enc
          retention-days: 3

      - name: "Display files structure"
        if: always()
        env:
          LOG_NAMES: logs-${{ inputs.file-name }}
        shell: bash
        run: |
          .ci/display_logs_locals.sh

      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de #v5.5.2
        name: "Upload coverage to Codecov"
        if: inputs.codecov-report == true
        with:
          token: ${{ secrets.codecov-token }} # required
          root_dir: ${{ github.workspace }}
          name: ${{ inputs.file-name }}.xml
          flags: local-ubuntu-${{ inputs.mapdl-version }}-dmp-${{ steps.student_check.outputs.TAG_STUDENT }}-${{ inputs.tags }}

      - name: "Upload coverage artifacts"
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        if: inputs.codecov-report == true
        with:
          name: ${{ inputs.file-name }}.xml
          path: ./${{ inputs.file-name }}.xml

      - name: "Show space consumption (post-test)"
        if: always()
        shell: bash
        run: |
          echo "Disk space:"
          df -h
