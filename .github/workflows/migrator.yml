# .github/workflows/recreate-pr.yml
name: Fork PR Handler

on:
  issue_comment:
    types: [created]

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number

jobs:
  recreate:
    if: |
       (
        github.event.issue.pull_request != null &&
        contains(github.event.comment.body, '@pyansys-ci-bot migrate') &&
        github.event.comment.user.login == 'germa89' 
        ) || ( github.event_name == 'workflow_dispatch' )
    runs-on: ubuntu-latest
    steps:
      - name: "Configuration"
        id: config
        run: |
          if [[ ${{ github.event_name }} == "workflow_dispatch" ]] ; then
            echo "On workflow dispatch"
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "On ${{ github.event_name }}"
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi;

      - name: React to comment
        if : ${{ github.event_name == 'issue_comment' }}
        uses: dkershner6/reaction-action@v2
        with:
          token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
          commentId: ${{ github.event.comment.id }} # Optional if the trigger is a comment. Use another action to find this otherwise.
          reaction: "rocket"

      - uses: actions/checkout@v3
        with:
          ref: ${{ steps.pr.outputs.data.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Check out the branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: | 
          gh pr checkout ${{ steps.config.outputs.issue_number }}
          echo $(git status)

      - name: Clone PR branch from fork
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_BRANCH=migrated/pr-${{ steps.config.outputs.issue_number }}

          # echo "Setting up git"
          git config --global user.name "${{ secrets.PYANSYS_CI_BOT_USERNAME }}"
          git config --global user.email "${{ secrets.PYANSYS_CI_BOT_EMAIL}}"

          echo "Adding new remote"
          git remote add dest https://x-access-token:${{ secrets.PYANSYS_CI_BOT_TOKEN }}@github.com/${{ github.repository }}.git

          echo "Pushing to new remote"
          git push dest HEAD:refs/heads/$NEW_BRANCH

          echo "Creating PR"
          gh pr create --head $NEW_BRANCH --title "Migrated PR #${{ steps.config.outputs.issue_number }}" --body "This PR was migrated from a fork to allow secrets to run in workflows."
